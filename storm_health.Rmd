---
title: "Storm's Health and Economic Impacts"
output: html_document
---

# Loading and Processing Raw Data
This data is coming from U.S. National Oceanic and Atmospheric Adminstraion's (NOAA) storm database. This database tracks characteristics of major storms and weather events in the United States, including when and where they occur, as well as estimates of any fatalities, injuries, and property damage.
The data file (repdata-data-StormData.csv) includes the storm data from 1950 to November 2011. The documentation about the data can be found at:

* National Weather Service [Storm Data Documentation](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf) 
* National Climatic Data Center Storm Events [FAQ](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2FNCDC%20Storm%20Events-FAQ%20Page.pdf)

```{r cache=TRUE}
storm.data <- read.csv("repdata-data-StormData.csv", stringsAsFactors = FALSE)
str(storm.data)
```

We are going to look at health and economic impacts of each events arcoss US. So we will need only a few columns from the data -  FATALITIES, INJURIES, PROPDMG, PROPDMGEXP, CROPDMG, CROPDMGEXP. We will also select Date information - we chose BGN_DATE - along with event type - EVTYPE.

Also column types are modified. We created a date column, the info of which is coming from BGN_DATE column. From this date colume, year column is created. Also EVTTYPE column becomes factor.

```{r cache=TRUE}
columns <- c(2,8,23:28)
storm <- storm.data[,columns]
str(storm)

storm$date <- as.Date(storm$BGN_DATE, "%m/%d/%Y %H:%M:%S")
storm$year <- strftime(storm$date, "%Y")
storm$EVTYPE <- as.factor(storm$EVTYPE)
```

Make Property Damage (PROPDMG) and Crop Damage (CROPDMG) columns as full number, using PROPDMGEXP and CROPDMGEXP ("K" for thousand, "M" for million, "B" for billion, all others are ignored).
Then select only necessary columns.

```{r cache=TRUE}
storm <- transform(storm, PROPDMG = ifelse(PROPDMGEXP == "K", PROPDMG * 1E3, 
                                           ifelse(PROPDMGEXP == "M", PROPDMG * 1E6, 
                                                  ifelse(PROPDMGEXP == "B", 
                                                         PROPDMG * 1E9, PROPDMG))))
storm <- transform(storm, CROPDMG = ifelse(CROPDMGEXP == "K", CROPDMG * 1E3, 
                                           ifelse(CROPDMGEXP == "M", CROPDMG * 1E6, 
                                                  ifelse(CROPDMGEXP == "B", 
                                                         CROPDMG * 1E9, CROPDMG))))
storm <- subset(storm, select = c("date", "year", "EVTYPE", "FATALITIES", "INJURIES", "PROPDMG", "CROPDMG"))
storm$total.dmg <- storm$PROPDMG + storm$CROPDMG
str(storm)
```

Group storm data by year and event type and compute the total dmage by the group
```{r}
library(dplyr)
storm.by.year.evt <- group_by(storm, year, EVTYPE)
sum.dmg.by.year.evt <- summarise(storm.by.year.evt, sum.dmg = sum(total.dmg))
head(sum.dmg.by.year.evt)
dim(sum.dmg.by.year.evt)
```
Dimension of sum.dmg.by.year.evt shows that there are 2326 events. We will focus on 10 events that caused most damages

Calculate total sum of damage and order them from the top so that we can select only the top 10 events.

```{r}
s <- group_by(sum.dmg.by.year.evt, EVTYPE)
ss <- summarise(s, total.dmg = sum(sum.dmg))
top10evt <- ss[order(ss$total.dmg, decreasing = TRUE),]$EVTYPE[1:10]
```
Select rows from s that belong to top10evt 
```{r}
dmg.top <- s[s$EVTYPE %in% top10evt,]
```

Plot dmg.by.top event so that shows dmg by each event at each year. However here, the largest damge is a rather large compared to  others so we limit the y range, which help us to better compare other events.

Top 10 largest damage:
```{r}
dmg.top[order(dmg.top$sum.dmg, decreasing = TRUE),]
```

Reduced y range - this is to zoom in to the busy area.
```{r message= FALSE}
library(ggplot2)
```
```{r}
g <- ggplot(dmg.top, aes(as.numeric(year), sum.dmg, colour=EVTYPE))
g + ylim(0, 6E10) + geom_line()
```
This plot show before early 1990s, only tornado was the event that caused a significant damage. We suspect that not enough data may have been collected befor that time. So we decided make comparison only after that time. In order to find the exact year where more data became available. We sorted dmg.top data by year and cut the data from 1985 to 1995.

```{r}
dmg.top.order.year <- dmg.top[order(as.numeric(dmg.top$year)),]
zoom <- dmg.top.order.year[dmg.top.order.year$year > 1985 & dmg.top.order.year$year < 1995,]
as.data.frame(zoom)
```

```{r}
dmg.ext <- subset(dmg.top, as.numeric(year) > 1992)
g <- ggplot(dmg.ext, aes(as.numeric(year), sum.dmg, colour=EVTTYPE))
g+geom_line()
```
